<!doctype html>

<html lang="en">
  <head>
    <!-- Meta tags for responsive design and character encoding -->
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <title>Sleep Outside | Checkout</title>

    <!-- Main stylesheet -->
    <link rel="stylesheet" href="../css/style.css" />

    <!-- Checkout functionality -->
    <script src="../js/checkout.js" type="module"></script>

    <!-- Header and footer injection -->
    <script src="../js/headerFooter.js" type="module"></script>
    <script type="module">import { injectHeaderFooter } from '../js/headerFooter.js'; injectHeaderFooter();</script>
  </head>

  <body>
    <header class="divider" id="main-header"></header>
    <main class="divider">
      <div class="hero">
        <img
          src="../images/banner-sm.jpg"
          srcset="../images/banner-sm.jpg 500w, ../images/banner.jpg"
          alt="image of a high mountain lake"
        />
        <div class="mission">
          <p>Complete your order and choose your payment method below.</p>
        </div>
      </div>
      <section class="products">
        <h2>Order Summary</h2>
        <ul class="product-list" id="checkout-cart-list">
          <!-- Cart items will be dynamically inserted here -->
        </ul>
        <div id="checkout-total" style="font-size:1.2em;font-weight:bold;margin-top:1em;"></div>
        <h3 style="margin-top:2em;">Payment Method</h3>
        <form id="checkoutForm" novalidate>
          <label><input type="radio" name="payment" value="mtn" required> MTN Mobile Money</label><br>
          <label><input type="radio" name="payment" value="vodafone"> Vodafone Cash</label><br>
          <label><input type="radio" name="payment" value="card"> Credit Card</label><br><br>
          <div id="payment-fields">
            <!-- Dynamic payment fields will be inserted here -->
          </div>
          <label for="name">Name:</label>
          <input type="text" id="name" name="name" required /><br />
          <label for="email">Email:</label>
          <input type="email" id="email" name="email" required /><br />
          <label for="address">Address:</label>
          <input type="text" id="address" name="address" required /><br />
          <div id="checkoutErrors" style="color:red; display:none;"></div>
          <button type="submit" style="margin-top:1em;">Place Order</button>
        </form>
      </section>
    </main>
    <footer id="main-footer"></footer>
    <script type="module">
      import { getLocalStorage } from '../js/utils.mjs';
      // Render cart items and total
      function renderCheckoutCart() {
        const cartItems = getLocalStorage('so-cart') || [];
        const list = document.getElementById('checkout-cart-list');
        let total = 0;
        list.innerHTML = cartItems.map(item => {
          let price = item.FinalPrice;
          let discountHTML = '';
          if (item.FinalPrice < item.SuggestedRetailPrice) {
            const percent = Math.round(100 - (item.FinalPrice / item.SuggestedRetailPrice) * 100);
            discountHTML = `<span style='color:#e53935;font-size:0.9em;margin-left:0.5em;'>(${percent}% OFF)</span>`;
          }
          price = Number(price);
          const qty = item.quantity || 1;
          total += price * qty;
          return `<li class='cart-card divider'>
            <img src='${item.Image}' alt='${item.Name}' style='width:60px;height:60px;vertical-align:middle;margin-right:1em;'>
            <span>${item.Name}</span> x${qty} <span style='float:right;'>$${(price * qty).toFixed(2)}${discountHTML}</span>
          </li>`;
        }).join('');
        document.getElementById('checkout-total').textContent = `Total: $${total.toFixed(2)}`;
      }
      renderCheckoutCart();
      // Payment method dynamic fields
      const paymentFields = document.getElementById('payment-fields');
      document.querySelectorAll('input[name="payment"]').forEach(radio => {
        radio.addEventListener('change', function() {
          if (this.value === 'mtn') {
            paymentFields.innerHTML = `<label for='mtn-number'>MTN Mobile Number:</label><input type='text' id='mtn-number' name='mtn-number' required pattern='^0[235]\d{8}$'><br/>`;
          } else if (this.value === 'vodafone') {
            paymentFields.innerHTML = `<label for='vodafone-number'>Vodafone Number:</label><input type='text' id='vodafone-number' name='vodafone-number' required pattern='^0[235]\d{8}$'><br/>`;
          } else if (this.value === 'card') {
            paymentFields.innerHTML = `<label for='card'>Card Number:</label><input type='text' id='card' name='card' maxlength='16' required pattern='^\d{16}$'><br/>`;
          }
        });
      });
      // Simple form validation
      document.getElementById('checkoutForm').addEventListener('submit', function(event) {
        let valid = true;
        let messages = [];
        const name = this.elements['name'].value.trim();
        const email = this.elements['email'].value.trim();
        const address = this.elements['address'].value.trim();
        const payment = this.elements['payment'].value;
        if (!name) { valid = false; messages.push('Name is required.'); }
        if (!email || !/^[^@\s]+@[^@\s]+\.[^@\s]+$/.test(email)) { valid = false; messages.push('A valid email is required.'); }
        if (!address) { valid = false; messages.push('Address is required.'); }
        if (!payment) { valid = false; messages.push('Select a payment method.'); }
        if (payment === 'mtn') {
          const mtn = this.elements['mtn-number'].value.trim();
          if (!/^0[235]\d{8}$/.test(mtn)) { valid = false; messages.push('Enter a valid MTN number.'); }
        }
        if (payment === 'vodafone') {
          const vodafone = this.elements['vodafone-number'].value.trim();
          if (!/^0[235]\d{8}$/.test(vodafone)) { valid = false; messages.push('Enter a valid Vodafone number.'); }
        }
        if (payment === 'card') {
          const card = this.elements['card'].value.trim();
          if (!/^\d{16}$/.test(card)) { valid = false; messages.push('Enter a valid 16-digit card number.'); }
        }
        const errorDiv = document.getElementById('checkoutErrors');
        if (!valid) {
          event.preventDefault();
          errorDiv.innerHTML = messages.map(msg => `<p>${msg}</p>`).join('');
          errorDiv.style.display = 'block';
        } else {
          errorDiv.style.display = 'none';
          alert('Order placed successfully!');
          // Optionally clear cart and redirect
          localStorage.removeItem('so-cart');
          window.location.href = '/index.html';
        }
      });
    </script>
  </body>
</html>
